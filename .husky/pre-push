#!/bin/sh
# Tables Magiques Pre-Push Hook v1.0 - ISO/IEC 25010 Quality
# AdaptÃ© de Chess App v3.0 - Environnement familial
# Date: 2025-12-25
# Standards: ISO/IEC 25010, ISO/IEC 29119 (Tests)

set -e

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘           ğŸ¦„ TABLES MAGIQUES - PRE-PUSH VALIDATION               â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ============================================
# 1. TYPESCRIPT STRICT CHECK
# ============================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“‹ VALIDATION QUALITÃ‰ PRÃ‰-PUSH"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo ""
echo "ğŸ” TypeScript strict check..."
if npm run typecheck 2>/dev/null; then
  echo "  âœ… TypeScript: 0 erreur"
else
  echo "  âŒ Erreurs TypeScript - PUSH BLOQUÃ‰"
  echo "  ExÃ©cuter: npm run typecheck"
  exit 1
fi

# ============================================
# 2. ESLINT - ZERO TOLERANCE
# ============================================
echo ""
echo "ğŸ” ESLint check..."
if npm run lint 2>/dev/null; then
  echo "  âœ… ESLint: OK"
else
  echo "  âŒ Erreurs ESLint - PUSH BLOQUÃ‰"
  echo "  ExÃ©cuter: npm run lint"
  exit 1
fi

# ============================================
# 3. TESTS UNITAIRES (Vitest)
# ============================================
echo ""
echo "ğŸ§ª Tests unitaires..."

# VÃ©rifier si des tests existent
if [ -d "tests" ] && find tests -name "*.test.ts" -o -name "*.test.tsx" 2>/dev/null | grep -q .; then
  if npm run test:run 2>/dev/null; then
    echo "  âœ… Tests: 100% passing"
  else
    echo "  âŒ Tests Ã©chouÃ©s - PUSH BLOQUÃ‰"
    echo "  ExÃ©cuter: npm test"
    exit 1
  fi
else
  echo "  â„¹ï¸  Aucun test unitaire trouvÃ© (skip)"
fi

# ============================================
# 4. BUILD PRODUCTION
# ============================================
echo ""
echo "ğŸ—ï¸ Build production..."
if npm run build 2>/dev/null; then
  echo "  âœ… Build: OK"
else
  echo "  âŒ Build Ã©chouÃ© - PUSH BLOQUÃ‰"
  echo "  ExÃ©cuter: npm run build"
  exit 1
fi

# ============================================
# 5. DÃ‰PENDANCES CIRCULAIRES (madge)
# ============================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š ANALYSE ARCHITECTURE"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo ""
echo "ğŸ“Š DÃ©pendances circulaires..."

set +e
npm run quality:circular > /tmp/madge-output.txt 2>&1
MADGE_EXIT=$?
set -e

if [ $MADGE_EXIT -ne 0 ]; then
  CIRCULAR_COUNT=$(grep -cE "^[0-9]+\)" /tmp/madge-output.txt 2>/dev/null || echo "0")
  if [ "$CIRCULAR_COUNT" -gt 0 ]; then
    echo "  âŒ $CIRCULAR_COUNT dÃ©pendances circulaires dÃ©tectÃ©es!"
    cat /tmp/madge-output.txt
    echo "  Action: Refactorer pour Ã©liminer les imports circulaires"
    exit 1
  fi
fi
echo "  âœ… 0 dÃ©pendances circulaires"

# ============================================
# 6. DUPLICATION CODE (jscpd)
# ============================================
echo ""
echo "ğŸ” Analyse duplication..."
mkdir -p reports/duplication
npm run quality:duplication > /dev/null 2>&1 || true
if [ -f "reports/duplication/jscpd-report.html" ]; then
  echo "  âœ… Rapport gÃ©nÃ©rÃ©: reports/duplication/"
else
  echo "  â„¹ï¸  Analyse duplication indisponible"
fi

# ============================================
# 7. RÃ‰GÃ‰NÃ‰RATION SVG DIAGRAMMES
# ============================================
echo ""
echo "ğŸ“Š VÃ©rification diagrammes..."

# Si fichiers .mmd (Mermaid) modifiÃ©s â†’ rÃ©gÃ©nÃ©rer SVG
if git diff --cached --name-only | grep -qE "\.mmd$"; then
  echo "  ğŸ“ Diagrammes Mermaid modifiÃ©s..."

  # VÃ©rifier si mmdc (mermaid-cli) est installÃ©
  if command -v mmdc &> /dev/null || npx mmdc --version &> /dev/null 2>&1; then
    mkdir -p docs/diagrams
    for mmd_file in $(git diff --cached --name-only | grep -E "\.mmd$"); do
      svg_file="${mmd_file%.mmd}.svg"
      npx mmdc -i "$mmd_file" -o "$svg_file" 2>/dev/null || true
      if [ -f "$svg_file" ]; then
        git add "$svg_file" 2>/dev/null || true
        echo "  âœ… GÃ©nÃ©rÃ©: $svg_file"
      fi
    done
  else
    echo "  âš ï¸  mermaid-cli non installÃ© (npm install -D @mermaid-js/mermaid-cli)"
  fi
else
  echo "  â„¹ï¸  Aucun diagramme modifiÃ©"
fi

# ============================================
# 8. E2E COVERAGE DOC UPDATE
# ============================================
echo ""
echo "ğŸ“Š Mise Ã  jour doc E2E coverage..."

E2E_DOC="docs/E2E-COVERAGE.md"
E2E_DIR="tests/e2e"

if [ -d "$E2E_DIR" ]; then
  # Compter tests E2E
  TOTAL_TESTS=$(find "$E2E_DIR" -name "*.spec.ts" -exec grep -c "test(" {} \; 2>/dev/null | awk '{sum+=$1} END {print sum}' || echo "0")
  TOTAL_FILES=$(find "$E2E_DIR" -name "*.spec.ts" 2>/dev/null | wc -l || echo "0")

  # CrÃ©er/mettre Ã  jour doc
  mkdir -p docs
  TIMESTAMP=$(date +"%Y-%m-%d %H:%M")

  cat > "$E2E_DOC" << EOF
# E2E Test Coverage

> **DerniÃ¨re mise Ã  jour**: $TIMESTAMP
> **Total fichiers E2E**: $TOTAL_FILES
> **Total tests E2E**: $TOTAL_TESTS

## Fichiers de test

EOF

  # Lister les fichiers de test
  for test_file in $(find "$E2E_DIR" -name "*.spec.ts" 2>/dev/null); do
    test_count=$(grep -c "test(" "$test_file" 2>/dev/null || echo "0")
    echo "- \`$(basename $test_file)\`: $test_count tests" >> "$E2E_DOC"
  done

  git add "$E2E_DOC" 2>/dev/null || true
  echo "  âœ… Doc E2E mise Ã  jour ($TOTAL_TESTS tests / $TOTAL_FILES fichiers)"
else
  echo "  â„¹ï¸  Aucun test E2E trouvÃ©"
fi

# ============================================
# 9. E2E TESTS (si dÃ©ployÃ©)
# ============================================
echo ""
echo "ğŸ­ Tests E2E..."

if [ "$SKIP_E2E" = "1" ]; then
  echo "  âš ï¸  E2E skipped (SKIP_E2E=1)"
elif [ -f "playwright.config.ts" ] && find tests/e2e -name "*.spec.ts" 2>/dev/null | grep -q .; then
  # VÃ©rifier si serveur local ou prod
  if [ -n "$NEXT_PUBLIC_APP_URL" ] && [ "$NEXT_PUBLIC_APP_URL" != "http://localhost:3000" ]; then
    echo "  ğŸŒ Target: $NEXT_PUBLIC_APP_URL"
    if npm run test:e2e 2>/dev/null; then
      echo "  âœ… E2E: passing"
    else
      echo "  âš ï¸  E2E Ã©chouÃ©s (non-bloquant en dev)"
    fi
  else
    echo "  â„¹ï¸  E2E skipped (localhost - Ã  activer aprÃ¨s dÃ©ploiement)"
  fi
else
  echo "  â„¹ï¸  Playwright non configurÃ© ou pas de tests"
fi

# ============================================
# 10. VERIFICATION COMMITS (bypass detection)
# ============================================
echo ""
echo "ğŸ” Verification commits..."

VALID_COMMITS_LOG=".git/tm-valid-commits.log"
if [ -f "$VALID_COMMITS_LOG" ]; then
  # Compter commits non verifies dans les 5 derniers
  LAST_COMMITS=$(git log --format="%H" -n 5 2>/dev/null)
  UNVERIFIED=0

  for commit in $LAST_COMMITS; do
    short=$(echo "$commit" | cut -c1-7)
    if ! grep -q "$short" "$VALID_COMMITS_LOG" 2>/dev/null; then
      UNVERIFIED=$((UNVERIFIED + 1))
    fi
  done

  if [ "$UNVERIFIED" -gt 0 ]; then
    echo "  âš ï¸  $UNVERIFIED commit(s) recent(s) sans verification hooks"
    echo "  â„¹ï¸  Rappel: Eviter --no-verify pour la qualite du code"
  else
    echo "  âœ… Tous les commits recents sont verifies"
  fi
else
  echo "  â„¹ï¸  Log de verification non disponible (nouveau repo)"
fi

# ============================================
# RÃ‰SUMÃ‰
# ============================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“‹ CHECKLIST PRÃ‰-PUSH"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  âœ… TypeScript: 0 erreur"
echo "  âœ… ESLint: 0 erreur"
echo "  âœ… Build: OK"
echo "  âœ… Architecture: 0 dÃ©pendance circulaire"
echo "  âœ… Documentation: mise Ã  jour"
echo ""
echo "âœ… Push autorisÃ© - QualitÃ© ISO/IEC 25010 OK"
echo ""
