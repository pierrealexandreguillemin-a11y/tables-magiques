#!/bin/sh
# Tables Magiques Pre-Commit Hook v1.0 - ISO/IEC 25010 Quality
# Adapt√© de Chess App v5.0 - Environnement familial (non hostile)
# Date: 2025-12-25
# Standards: ISO/IEC 25010, ISO/IEC 5055, MISRA Type Safety

echo "üîç Validation qualit√© ISO/IEC 25010..."

# ============================================
# 0. SECRET SCANNING (S√©curit√©)
# ============================================
echo ""
echo "üîê Scan des secrets..."

GITLEAKS_BIN=""
if [ -f "./tools/gitleaks.exe" ]; then
  GITLEAKS_BIN="./tools/gitleaks.exe"
elif [ -f "./tools/gitleaks" ]; then
  GITLEAKS_BIN="./tools/gitleaks"
elif command -v gitleaks &> /dev/null; then
  GITLEAKS_BIN="gitleaks"
fi

if [ -n "$GITLEAKS_BIN" ]; then
  $GITLEAKS_BIN protect --staged --source . --verbose --redact --no-banner 2>&1
  GITLEAKS_EXIT=$?

  if [ $GITLEAKS_EXIT -ne 0 ]; then
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë  ‚ùå SECRETS D√âTECT√âS - COMMIT BLOQU√â                          ‚ïë"
    echo "‚ïë                                                               ‚ïë"
    echo "‚ïë  Action: Supprimer les secrets et utiliser .env.local         ‚ïë"
    echo "‚ïë  Les fichiers .env ne doivent JAMAIS √™tre commit√©s            ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    exit 1
  fi
  echo "  ‚úÖ Aucun secret d√©tect√©"
else
  echo "  ‚ö†Ô∏è  Gitleaks non install√© (recommand√©: choco install gitleaks)"
  echo "  ‚ÑπÔ∏è  Continuons sans scan de secrets..."
fi

# ============================================
# 1. FORMATAGE + LINT (lint-staged)
# ============================================
echo ""
echo "üé® Formatage + Lint..."
npx lint-staged

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå COMMIT BLOQU√â: Erreurs lint-staged"
  echo "Action: Corriger les erreurs ci-dessus"
  exit 1
fi

echo "  ‚úÖ Formatage + lint OK"

# ============================================
# 2. TYPE SAFETY - ISO/IEC 5055 (CWE-704)
# ============================================
echo ""
echo "üîç V√©rification type safety..."

STAGED_TS_TSX=$(git diff --cached --name-only --diff-filter=ACM | grep -E "\.(ts|tsx)$" | grep -v "\.test\." | grep -v "\.spec\." || true)

if [ -n "$STAGED_TS_TSX" ]; then
  # D√©tecter "as Type" (sauf "as const")
  TYPE_ASSERTIONS=$(echo "$STAGED_TS_TSX" | xargs grep -nE "\bas [A-Z][a-zA-Z]*(\[\])?(\s*\||\s*;|\s*,|\s*\)|\s*$)" 2>/dev/null | grep -v "as const" || true)

  if [ -n "$TYPE_ASSERTIONS" ]; then
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë  ‚ùå COMMIT BLOQU√â: Type assertions d√©tect√©es                  ‚ïë"
    echo "‚ïë                                                               ‚ïë"
    echo "‚ïë  ISO/IEC 5055 - CWE-704: Type conversion non s√ªre            ‚ïë"
    echo "‚ïë                                                               ‚ïë"
    echo "‚ïë  Patterns autoris√©s:                                         ‚ïë"
    echo "‚ïë    ‚úÖ Type guards: if (isType(x)) { ... }                    ‚ïë"
    echo "‚ïë    ‚úÖ as const (literal types)                               ‚ïë"
    echo "‚ïë                                                               ‚ïë"
    echo "‚ïë  Patterns bloqu√©s:                                           ‚ïë"
    echo "‚ïë    ‚ùå as Type                                                ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    echo "Fichiers concern√©s:"
    echo "$TYPE_ASSERTIONS"
    exit 1
  fi
  echo "  ‚úÖ Type safety conforme"
else
  echo "  ‚ÑπÔ∏è  Aucun fichier TypeScript staged"
fi

# ============================================
# 3. CATCH VIDES INTERDITS
# ============================================
echo ""
echo "üîç V√©rification catch vides..."

if [ -n "$STAGED_TS_TSX" ]; then
  EMPTY_CATCH=$(echo "$STAGED_TS_TSX" | xargs grep -nE "catch\s*(\([^)]*\))?\s*\{\s*\}" 2>/dev/null || true)

  if [ -n "$EMPTY_CATCH" ]; then
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë  ‚ùå COMMIT BLOQU√â: Catch vide d√©tect√©                        ‚ïë"
    echo "‚ïë                                                               ‚ïë"
    echo "‚ïë  Les erreurs doivent √™tre logg√©es:                           ‚ïë"
    echo "‚ïë    ‚ùå catch { }                                              ‚ïë"
    echo "‚ïë    ‚úÖ catch (error) { console.error(error) }                 ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    echo "Fichiers concern√©s:"
    echo "$EMPTY_CATCH"
    exit 1
  fi
  echo "  ‚úÖ Aucun catch vide"
fi

# ============================================
# 4. TDD - Tests avant code (Warning)
# ============================================
echo ""
echo "üîç V√©rification TDD..."

STAGED_SOURCE=$(git diff --cached --name-only --diff-filter=A | grep -E "\.(ts|tsx)$" | grep -v "\.test\." | grep -v "\.spec\." | grep -v "types/" | grep -v "config/" || true)
STAGED_TESTS=$(git diff --cached --name-only --diff-filter=A | grep -E "\.(test|spec)\.(ts|tsx)$" || true)

if [ -n "$STAGED_SOURCE" ]; then
  MISSING_TESTS=""

  for source_file in $STAGED_SOURCE; do
    base_name=$(basename "$source_file" | sed 's/\.\(ts\|tsx\)$//')

    # Skip fichiers sans logique (types, index, constants)
    if echo "$source_file" | grep -qE "(types|index|constants|config)\.(ts|tsx)$"; then
      continue
    fi

    # Chercher test correspondant
    has_test=false
    for test_file in $STAGED_TESTS; do
      if echo "$test_file" | grep -q "$base_name"; then
        has_test=true
        break
      fi
    done

    if [ "$has_test" = false ]; then
      MISSING_TESTS="$MISSING_TESTS\n  - $source_file"
    fi
  done

  if [ -n "$MISSING_TESTS" ]; then
    echo ""
    echo "  ‚ö†Ô∏è  TDD: Fichiers sans tests correspondants:"
    echo -e "$MISSING_TESTS"
    echo ""
    echo "  Rappel TDD: √âcrire le test AVANT le code"
    echo "  (Warning non-bloquant)"
  else
    echo "  ‚úÖ TDD respect√©"
  fi
else
  echo "  ‚ÑπÔ∏è  Aucun nouveau fichier source"
fi

# ============================================
# 5. TYPESCRIPT COMPILATION
# ============================================
echo ""
echo "üìò Compilation TypeScript..."

npx tsc --noEmit > /tmp/tsc-output.txt 2>&1
TSC_EXIT=$?

if [ $TSC_EXIT -ne 0 ]; then
  echo ""
  echo "‚ùå COMMIT BLOQU√â: Erreurs TypeScript"
  cat /tmp/tsc-output.txt
  exit 1
fi

echo "  ‚úÖ TypeScript: 0 erreur"

# ============================================
# R√âSUM√â
# ============================================
echo ""
echo "‚úÖ Validation qualit√© OK (ISO/IEC 25010)"
echo "   Type Safety ‚úì | Error Handling ‚úì | TypeScript ‚úì"
echo ""
